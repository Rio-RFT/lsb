name: Build and Release FiveM Launcher

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., v1.0.0)'
        required: true

jobs:
  build:
    runs-on: windows-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          submodules: recursive
          
      - name: Setup Visual Studio
        uses: microsoft/setup-msbuild@v1
        
      - name: Setup Premake
        run: |
          curl -L -o premake5.zip https://github.com/premake/premake-core/releases/download/v5.0.0-beta2/premake-5.0.0-beta2-windows.zip
          Expand-Archive premake5.zip -DestinationPath premake
          
      - name: Generate Project
        run: |
          cd code
          ../premake/premake5 vs2022
          
      - name: Build
        run: |
          msbuild code/build/CitizenMP.sln /p:Configuration=Release /p:Platform=x64
          
      - name: Package
        run: |
          mkdir release
          # Copy main executable
          copy code\bin\Release\FiveM.exe release\
          # Add more files as needed
          
      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          files: |
            release/*
          tag_name: ${{ github.event.inputs.version || github.ref_name }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
  notify-update-server:
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Update Server Sync
        run: |
          curl -X POST ${{ secrets.UPDATE_SERVER_URL }}/webhook/sync \
            -H "Authorization: Bearer ${{ secrets.UPDATE_SERVER_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{"tag": "${{ github.ref_name }}"}'
